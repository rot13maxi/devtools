#!/usr/bin/env bash
set -euo pipefail

TOOL_NAME="agentvm"
BASE_INSTANCE="agentvm-base"
BASE_SNAPSHOT="base"
PROVISION_STAMP="/var/lib/agentvm/provisioned-v1"
MANIFEST_HASH_FILE="/var/lib/agentvm/manifest.sha256"
GUEST_MOUNT_POLICY_PATH='${HOME}/.agentvm/mount-policy'
MOUNT_POLICY_VERSION="v1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_BASE_MANIFEST_DIR="${SCRIPT_DIR}/../manifests/base"
SHIMS_DIR="${SCRIPT_DIR}/../shims"
LOCK_ROOT="${TMPDIR:-/tmp}/agentvm-locks"
LOCK_TIMEOUT_SECONDS="${AGENTVM_LOCK_TIMEOUT_SECONDS:-30}"
RETRY_ATTEMPTS="${AGENTVM_RETRY_ATTEMPTS:-3}"
RETRY_DELAY_SECONDS="${AGENTVM_RETRY_DELAY_SECONDS:-1}"
LOCK_PATHS=()

usage() {
  cat <<USAGE
Usage:
  ${TOOL_NAME} claude [args...]
  ${TOOL_NAME} codex [args...]
  ${TOOL_NAME} opencode [args...]
  ${TOOL_NAME} gh [args...]
  ${TOOL_NAME} run <claude|codex|opencode> [args...]
  ${TOOL_NAME} status
  ${TOOL_NAME} list
  ${TOOL_NAME} rm [instance]
  ${TOOL_NAME} prune
  ${TOOL_NAME} doctor
  ${TOOL_NAME} install-shims [dir]
  ${TOOL_NAME} base init
  ${TOOL_NAME} base apply
  ${TOOL_NAME} base shell
  ${TOOL_NAME} base snapshot
  ${TOOL_NAME} base reset

Environment:
  AGENTVM_BASE_INSTANCE              Base Lima instance name (default: ${BASE_INSTANCE})
  AGENTVM_BASE_SNAPSHOT              Snapshot name for base maintenance (default: ${BASE_SNAPSHOT})
  AGENTVM_BASE_MANIFEST_DIR          Path to base manifest dir (default: ${DEFAULT_BASE_MANIFEST_DIR})
  AGENTVM_MOUNT_GH_CONFIG=0|1        Mount ~/.config/gh into VM (default: 1)
  AGENTVM_MOUNT_GITCONFIG=0|1        Sync ~/.gitconfig into VM on each run (default: 1)
  AGENTVM_MOUNT_GIT_CREDENTIALS=0|1  Sync ~/.git-credentials into VM on each run (default: 1 if file exists)
  AGENTVM_MOUNT_SSH=0|1              Mount ~/.ssh into VM (default: 0)
  AGENTVM_YOLO=1                     Pass agent-specific dangerous bypass flags (default: 0)
  AGENTVM_SKIP_AUTO_INSTALL=1        Do not auto-install agent CLIs when missing
  AGENTVM_<AGENT>_INSTALL_CMD        Override install command for missing CLI in VM
                                     Agents: CLAUDE, CODEX, OPENCODE
  AGENTVM_GH_INSTALL_CMD             Override install command for missing gh CLI in VM
  AGENTVM_LOCK_TIMEOUT_SECONDS       Lock wait timeout in seconds (default: 30)
  AGENTVM_RETRY_ATTEMPTS             Retries for transient limactl failures (default: 3)
  AGENTVM_RETRY_DELAY_SECONDS        Delay between retries in seconds (default: 1)
USAGE
}

log() {
  printf '[agentvm] %s\n' "$*" >&2
}

die() {
  printf '[agentvm] ERROR: %s\n' "$*" >&2
  exit 1
}

cleanup_locks() {
  local lock_path
  for lock_path in "${LOCK_PATHS[@]:-}"; do
    rmdir "$lock_path" >/dev/null 2>&1 || true
  done
}
trap cleanup_locks EXIT

require_bin() {
  command -v "$1" >/dev/null 2>&1 || die "Missing required binary: $1"
}

has_bin() {
  command -v "$1" >/dev/null 2>&1
}

is_enabled() {
  local value="${1:-0}"
  case "$value" in
    1|true|TRUE|yes|YES|on|ON) return 0 ;;
    *) return 1 ;;
  esac
}

instance_exists() {
  local name="$1"
  limactl list --format '{{.Name}}' 2>/dev/null | grep -Fxq "$name"
}

delete_instance() {
  local name="$1"
  limactl stop "$name" >/dev/null 2>&1 || true
  limactl delete "$name" >/dev/null 2>&1 || limactl delete --force "$name" >/dev/null 2>&1 || limactl delete -f "$name" >/dev/null 2>&1 || die "Failed to delete broken instance: $name"
}

manifest_dir() {
  if [ -n "${AGENTVM_BASE_MANIFEST_DIR:-}" ]; then
    printf '%s\n' "$AGENTVM_BASE_MANIFEST_DIR"
  else
    printf '%s\n' "$DEFAULT_BASE_MANIFEST_DIR"
  fi
}

manifest_hash() {
  local dir="$1"
  [ -d "$dir" ] || die "Manifest directory not found: $dir"

  (
    cd "$dir"
    find . -type f | LC_ALL=C sort | while IFS= read -r file; do
      printf '%s\0' "$file"
      cat "$file"
      printf '\0'
    done
  ) | sha256_hex_stdin
}

sha256_hex_stdin() {
  if has_bin shasum; then
    shasum -a 256 | awk '{print $1}'
    return
  fi
  if has_bin sha256sum; then
    sha256sum | awk '{print $1}'
    return
  fi
  die "Missing required binary: shasum or sha256sum"
}

short_project_hash() {
  printf '%s' "$1" | sha256_hex_stdin | cut -c1-10
}

retry() {
  local attempts="$1"
  local delay="$2"
  shift 2

  local i=1
  while [ "$i" -le "$attempts" ]; do
    if "$@"; then
      return 0
    fi
    if [ "$i" -lt "$attempts" ]; then
      sleep "$delay"
    fi
    i=$((i + 1))
  done
  return 1
}

lima_retry() {
  retry "$RETRY_ATTEMPTS" "$RETRY_DELAY_SECONDS" "$@"
}

acquire_lock() {
  local name="$1"
  local lock_name lock_path elapsed=0

  lock_name="$(short_project_hash "$name")"
  lock_path="$LOCK_ROOT/$lock_name.lock"
  mkdir -p "$LOCK_ROOT"

  while ! mkdir "$lock_path" >/dev/null 2>&1; do
    if [ "$elapsed" -ge "$LOCK_TIMEOUT_SECONDS" ]; then
      die "Timed out waiting for lock: $name"
    fi
    sleep 1
    elapsed=$((elapsed + 1))
  done

  LOCK_PATHS+=("$lock_path")
}

list_agentvm_instances() {
  limactl list --format '{{.Name}}' 2>/dev/null | grep -E '^agentvm(-|$)' || true
}

guest_has_mount() {
  local instance="$1"
  local path="$2"
  limactl shell "$instance" env AGENTVM_CHECK_MOUNT_PATH="$path" bash -lc 'grep -Fq -- " $AGENTVM_CHECK_MOUNT_PATH " /proc/mounts'
}

desired_mount_policy() {
  local root="$1"
  local gh_enabled="$2"
  local ssh_enabled="$3"
  printf 'version=%s;root=%s;gh=%s;ssh=%s\n' "$MOUNT_POLICY_VERSION" "$root" "$gh_enabled" "$ssh_enabled"
}

apply_base_manifest() {
  local base="$1"
  local dir hash current_hash packages_file scripts_dir script
  local -a packages

  dir="$(manifest_dir)"
  hash="$(manifest_hash "$dir")"
  current_hash="$(limactl shell "$base" bash -lc "cat '$MANIFEST_HASH_FILE' 2>/dev/null || true" | tr -d '\r\n')"

  if [ "$hash" = "$current_hash" ] && limactl shell "$base" test -f "$PROVISION_STAMP" >/dev/null 2>&1; then
    log "Base manifest already applied ($hash)"
    return 0
  fi

  log "Applying base manifest from $dir"
  lima_retry limactl shell "$base" sudo mkdir -p "$(dirname "$PROVISION_STAMP")"

  packages_file="$dir/apt-packages.txt"
  if [ -f "$packages_file" ]; then
    packages=()
    while IFS= read -r pkg; do
      [ -n "$pkg" ] && packages+=("$pkg")
    done < <(awk '{sub(/[[:space:]]*#.*/, ""); gsub(/^[[:space:]]+|[[:space:]]+$/, ""); if (length) print}' "$packages_file")

    if [ "${#packages[@]}" -gt 0 ]; then
      log "Installing apt packages (${#packages[@]})"
      lima_retry limactl shell "$base" sudo env DEBIAN_FRONTEND=noninteractive apt-get update
      lima_retry limactl shell "$base" sudo env DEBIAN_FRONTEND=noninteractive apt-get install -y "${packages[@]}"
    fi
  fi

  scripts_dir="$dir/scripts"
  if [ -d "$scripts_dir" ]; then
    while IFS= read -r script; do
      log "Running manifest script: $(basename "$script")"
      lima_retry limactl shell "$base" sudo bash -s -- < "$script"
    done < <(find "$scripts_dir" -maxdepth 1 -type f -name '*.sh' | LC_ALL=C sort)
  fi

  lima_retry limactl shell "$base" sudo bash -lc "printf '%s\n' '$hash' > '$MANIFEST_HASH_FILE'; touch '$PROVISION_STAMP'"
  log "Base manifest applied ($hash)"
}

sync_host_file_to_guest_home() {
  local instance="$1"
  local host_path="$2"
  local guest_rel_path="$3"
  local mode="$4"

  [ -f "$host_path" ] || return 0
  lima_retry limactl shell "$instance" bash -lc "cat > \"\$HOME/$guest_rel_path\" && chmod '$mode' \"\$HOME/$guest_rel_path\"" < "$host_path"
}

remove_guest_home_file() {
  local instance="$1"
  local guest_rel_path="$2"
  lima_retry limactl shell "$instance" bash -lc "rm -f \"\$HOME/$guest_rel_path\""
}

project_root() {
  if git rev-parse --show-toplevel >/dev/null 2>&1; then
    git rev-parse --show-toplevel
  else
    pwd
  fi
}

project_instance_name() {
  local root="$1"
  local slug hash
  slug="$(basename "$root" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-')"
  slug="${slug#-}"
  slug="${slug%-}"
  [ -n "$slug" ] || slug="project"
  hash="$(short_project_hash "$root")"
  printf 'agentvm-%s-%s\n' "$slug" "$hash"
}

agent_install_cmd() {
  local agent="$1"
  case "$agent" in
    claude)
      printf '%s\n' "
        sudo npm install -g @anthropic-ai/claude-code
      "
      ;;
    codex)
      printf '%s\n' "
        sudo npm install -g @openai/codex
      "
      ;;
    opencode)
      printf '%s\n' "
        sudo npm install -g opencode-ai
      "
      ;;
    *)
      return 1
      ;;
  esac
}

supports_flag() {
  local instance="$1"
  local agent="$2"
  local flag="$3"

  limactl shell "$instance" env AGENTVM_FLAG_CLI="$agent" AGENTVM_FLAG_VALUE="$flag" bash -lc 'command -v "$AGENTVM_FLAG_CLI" >/dev/null 2>&1 && "$AGENTVM_FLAG_CLI" --help 2>&1 | grep -Fq -- "$AGENTVM_FLAG_VALUE"'
}

yolo_flags_for_agent() {
  local instance="$1"
  local agent="$2"
  local flags=()
  local candidate=""

  if ! is_enabled "${AGENTVM_YOLO:-0}"; then
    return 0
  fi

  case "$agent" in
    claude) candidate="--dangerously-skip-permissions" ;;
    codex) candidate="--dangerously-bypass-approvals-and-sandbox" ;;
    opencode) candidate="--yolo" ;;
  esac

  if [ -n "$candidate" ] && supports_flag "$instance" "$agent" "$candidate"; then
    flags+=("$candidate")
  fi

  printf '%s\n' "${flags[@]:-}"
}

ensure_base_instance() {
  local base="${AGENTVM_BASE_INSTANCE:-$BASE_INSTANCE}"
  acquire_lock "base:$base"

  if ! instance_exists "$base"; then
    log "Creating base VM: $base"
    lima_retry limactl create --name "$base" --mount-none template://default
  fi

  log "Starting base VM: $base"
  lima_retry limactl start "$base" >/dev/null
  apply_base_manifest "$base"
}

ensure_project_instance() {
  local instance="$1"
  local root="$2"
  local base="${AGENTVM_BASE_INSTANCE:-$BASE_INSTANCE}"
  local home_dir="$HOME"
  local expected_mount_policy existing_mount_policy
  local -a mount_args
  local mount_gh_config=0 mount_ssh=0 sync_gitconfig=0 sync_git_credentials=0
  local needs_create=0

  acquire_lock "project:$instance"

  mkdir -p "$home_dir/.claude" "$home_dir/.codex" "$home_dir/.config/opencode" "$home_dir/.config/gh"
  mount_args+=(
    --mount-only "$root"
    --mount-only "$home_dir/.claude"
    --mount-only "$home_dir/.codex"
    --mount-only "$home_dir/.config/opencode"
  )

  if is_enabled "${AGENTVM_MOUNT_GH_CONFIG:-1}"; then
    mount_gh_config=1
    mount_args+=(--mount-only "$home_dir/.config/gh")
  fi

  if is_enabled "${AGENTVM_MOUNT_GITCONFIG:-1}" && [ -f "$home_dir/.gitconfig" ]; then
    sync_gitconfig=1
  fi

  if is_enabled "${AGENTVM_MOUNT_GIT_CREDENTIALS:-1}" && [ -f "$home_dir/.git-credentials" ]; then
    sync_git_credentials=1
  fi

  if is_enabled "${AGENTVM_MOUNT_SSH:-0}" && [ -d "$home_dir/.ssh" ]; then
    mount_ssh=1
    mount_args+=(--mount-only "$home_dir/.ssh")
  fi

  if ! instance_exists "$instance"; then
    needs_create=1
  fi

  if [ "$needs_create" -eq 0 ]; then
    lima_retry limactl start "$instance" >/dev/null
    if ! guest_has_mount "$instance" "$root" >/dev/null 2>&1; then
      log "Existing VM '$instance' is missing project mount '$root'; recreating it"
      delete_instance "$instance"
      needs_create=1
    fi

    if [ "$needs_create" -eq 0 ]; then
      if [ "$mount_gh_config" -eq 1 ] && ! guest_has_mount "$instance" "$home_dir/.config/gh" >/dev/null 2>&1; then
        log "Existing VM '$instance' is missing requested gh config mount; recreating it"
        delete_instance "$instance"
        needs_create=1
      fi
    fi

    if [ "$needs_create" -eq 0 ]; then
      if [ "$mount_gh_config" -eq 0 ] && guest_has_mount "$instance" "$home_dir/.config/gh" >/dev/null 2>&1; then
        log "Existing VM '$instance' has gh config mount but AGENTVM_MOUNT_GH_CONFIG=0; recreating it"
        delete_instance "$instance"
        needs_create=1
      fi
    fi

    if [ "$needs_create" -eq 0 ]; then
      if [ "$mount_ssh" -eq 1 ] && ! guest_has_mount "$instance" "$home_dir/.ssh" >/dev/null 2>&1; then
        log "Existing VM '$instance' is missing requested SSH mount; recreating it"
        delete_instance "$instance"
        needs_create=1
      fi
    fi

    if [ "$needs_create" -eq 0 ]; then
      if [ "$mount_ssh" -eq 0 ] && guest_has_mount "$instance" "$home_dir/.ssh" >/dev/null 2>&1; then
        log "Existing VM '$instance' has SSH mount but AGENTVM_MOUNT_SSH=0; recreating it"
        delete_instance "$instance"
        needs_create=1
      fi
    fi

    if [ "$needs_create" -eq 0 ]; then
      expected_mount_policy="$(desired_mount_policy "$root" "$mount_gh_config" "$mount_ssh")"
      existing_mount_policy="$(limactl shell "$instance" bash -lc "cat \"$GUEST_MOUNT_POLICY_PATH\" 2>/dev/null || true" | tr -d '\r\n')"
      if [ -n "$existing_mount_policy" ] && [ "$existing_mount_policy" != "$expected_mount_policy" ]; then
        log "Existing VM '$instance' mount policy differs from requested settings; recreating it"
        delete_instance "$instance"
        needs_create=1
      fi
    fi
  fi

  if [ "$needs_create" -eq 1 ]; then
    ensure_base_instance
    log "Stopping base VM before cloning"
    limactl stop "$base" >/dev/null 2>&1 || true
    log "Cloning $base -> $instance"
    lima_retry limactl clone "${mount_args[@]}" "$base" "$instance"
    lima_retry limactl start "$instance" >/dev/null
  fi

  lima_retry limactl shell "$instance" env \
    AGENTVM_HOST_HOME="$home_dir" \
    AGENTVM_LINK_GH_CONFIG="$mount_gh_config" \
    AGENTVM_LINK_SSH="$mount_ssh" \
    bash -lc '
    set -euo pipefail
    mkdir -p "$HOME/.config"
    ln -sfn "$AGENTVM_HOST_HOME/.claude" "$HOME/.claude"
    ln -sfn "$AGENTVM_HOST_HOME/.codex" "$HOME/.codex"
    mkdir -p "$HOME/.config"
    ln -sfn "$AGENTVM_HOST_HOME/.config/opencode" "$HOME/.config/opencode"
    if [ "$AGENTVM_LINK_GH_CONFIG" = "1" ]; then
      mkdir -p "$HOME/.config"
      ln -sfn "$AGENTVM_HOST_HOME/.config/gh" "$HOME/.config/gh"
    elif [ -L "$HOME/.config/gh" ]; then
      rm -f "$HOME/.config/gh"
    fi
    if [ "$AGENTVM_LINK_SSH" = "1" ]; then
      ln -sfn "$AGENTVM_HOST_HOME/.ssh" "$HOME/.ssh"
      chmod 700 "$HOME/.ssh" || true
    elif [ -L "$HOME/.ssh" ]; then
      rm -f "$HOME/.ssh"
    fi
  '

  expected_mount_policy="$(desired_mount_policy "$root" "$mount_gh_config" "$mount_ssh")"
  lima_retry limactl shell "$instance" bash -lc "mkdir -p \"\$HOME/.agentvm\" && printf '%s\n' '$expected_mount_policy' > \"$GUEST_MOUNT_POLICY_PATH\""

  if [ "$sync_gitconfig" = "1" ]; then
    sync_host_file_to_guest_home "$instance" "$home_dir/.gitconfig" ".gitconfig" 0600
  else
    remove_guest_home_file "$instance" ".gitconfig"
  fi

  if [ "$sync_git_credentials" = "1" ]; then
    sync_host_file_to_guest_home "$instance" "$home_dir/.git-credentials" ".git-credentials" 0600
  else
    remove_guest_home_file "$instance" ".git-credentials"
  fi
}

ensure_agent_in_instance() {
  local instance="$1"
  local agent="$2"
  local env_key install_cmd

  if limactl shell "$instance" command -v "$agent" >/dev/null 2>&1; then
    return 0
  fi

  if [ "${AGENTVM_SKIP_AUTO_INSTALL:-0}" = "1" ]; then
    die "'$agent' not found in VM '$instance'. Run '${TOOL_NAME} base shell' to install it."
  fi

  case "$agent" in
    claude) env_key="AGENTVM_CLAUDE_INSTALL_CMD" ;;
    codex) env_key="AGENTVM_CODEX_INSTALL_CMD" ;;
    opencode) env_key="AGENTVM_OPENCODE_INSTALL_CMD" ;;
    *) die "Unsupported agent: $agent" ;;
  esac

  install_cmd="${!env_key:-}"
  if [ -z "$install_cmd" ]; then
    install_cmd="$(agent_install_cmd "$agent")"
  fi

  log "Installing missing '$agent' CLI in '$instance'"
  lima_retry limactl shell "$instance" bash -lc "$install_cmd"

  limactl shell "$instance" command -v "$agent" >/dev/null 2>&1 || die "Failed to install '$agent' in '$instance'"
}

ensure_gh_in_instance() {
  local instance="$1"
  local install_cmd

  if limactl shell "$instance" command -v gh >/dev/null 2>&1; then
    return 0
  fi

  if [ "${AGENTVM_SKIP_AUTO_INSTALL:-0}" = "1" ]; then
    die "'gh' not found in VM '$instance'. Run '${TOOL_NAME} base shell' to install it."
  fi

  install_cmd="${AGENTVM_GH_INSTALL_CMD:-sudo apt-get update && sudo apt-get install -y gh}"
  log "Installing missing 'gh' CLI in '$instance'"
  lima_retry limactl shell "$instance" bash -lc "$install_cmd"
  limactl shell "$instance" command -v gh >/dev/null 2>&1 || die "Failed to install 'gh' in '$instance'"
}

run_agent() {
  local agent="$1"
  shift || true

  case "$agent" in
    claude|codex|opencode) ;;
    *) die "Unsupported agent: $agent" ;;
  esac

  local root instance cwd_in_guest
  root="$(project_root)"
  instance="$(project_instance_name "$root")"
  cwd_in_guest="$(pwd)"

  ensure_project_instance "$instance" "$root"
  ensure_agent_in_instance "$instance" "$agent"

  local yolo_flag
  yolo_flag="$(yolo_flags_for_agent "$instance" "$agent")"

  log "Using VM: $instance"
  log "Project mount: $root"

  if [ -n "$yolo_flag" ]; then
    lima_retry limactl shell --workdir "$cwd_in_guest" "$instance" "$agent" "$yolo_flag" "$@"
  else
    lima_retry limactl shell --workdir "$cwd_in_guest" "$instance" "$agent" "$@"
  fi
}

run_gh() {
  local root instance cwd_in_guest
  root="$(project_root)"
  instance="$(project_instance_name "$root")"
  cwd_in_guest="$(pwd)"

  ensure_project_instance "$instance" "$root"
  ensure_gh_in_instance "$instance"

  log "Using VM: $instance"
  log "Project mount: $root"
  lima_retry limactl shell --workdir "$cwd_in_guest" "$instance" gh "$@"
}

show_status() {
  local root instance
  root="$(project_root)"
  instance="$(project_instance_name "$root")"

  printf 'project_root=%s\n' "$root"
  printf 'instance=%s\n' "$instance"

  if instance_exists "$instance"; then
    limactl list "$instance"
    printf 'mount_policy='
    limactl shell "$instance" bash -lc "cat \"$GUEST_MOUNT_POLICY_PATH\" 2>/dev/null || true"
  else
    printf 'instance_status=missing\n'
  fi
}

show_list() {
  local name
  while IFS= read -r name; do
    [ -n "$name" ] || continue
    limactl list "$name"
  done < <(list_agentvm_instances)
}

remove_instance() {
  local target="${1:-}"

  if [ -z "$target" ]; then
    target="$(project_instance_name "$(project_root)")"
  fi

  [ "$target" = "${AGENTVM_BASE_INSTANCE:-$BASE_INSTANCE}" ] && die "Refusing to remove base VM with rm. Use '${TOOL_NAME} base reset' or limactl directly."
  instance_exists "$target" || die "Instance not found: $target"

  acquire_lock "project:$target"
  log "Removing VM: $target"
  delete_instance "$target"
}

prune_instances() {
  local base="${AGENTVM_BASE_INSTANCE:-$BASE_INSTANCE}"
  local -a victims=()
  local name status

  while IFS=$'\t' read -r name status; do
    [ -n "$name" ] || continue
    [[ "$name" =~ ^agentvm- ]] || continue
    [ "$name" = "$base" ] && continue
    [ "$status" = "Running" ] && continue
    victims+=("$name")
  done < <(limactl list --format '{{.Name}}	{{.Status}}' 2>/dev/null || true)

  if [ "${#victims[@]}" -eq 0 ]; then
    log "No stopped agentvm instances to prune"
    return 0
  fi

  for name in "${victims[@]}"; do
    acquire_lock "project:$name"
    log "Pruning VM: $name"
    delete_instance "$name"
  done
}

show_doctor() {
  local root instance base
  root="$(project_root)"
  instance="$(project_instance_name "$root")"
  base="${AGENTVM_BASE_INSTANCE:-$BASE_INSTANCE}"

  printf 'limactl='
  if has_bin limactl; then
    limactl --version | head -n1
  else
    printf 'missing\n'
  fi

  printf 'base_instance=%s\n' "$base"
  printf 'base_exists=%s\n' "$(instance_exists "$base" && printf yes || printf no)"
  if instance_exists "$base"; then
    printf 'base_manifest_hash='
    limactl shell "$base" bash -lc "cat '$MANIFEST_HASH_FILE' 2>/dev/null || true"
  fi

  printf 'project_root=%s\n' "$root"
  printf 'project_instance=%s\n' "$instance"
  printf 'project_exists=%s\n' "$(instance_exists "$instance" && printf yes || printf no)"
  if instance_exists "$instance"; then
    printf 'project_mount_ok=%s\n' "$(guest_has_mount "$instance" "$root" && printf yes || printf no)"
    printf 'gh_mount_ok=%s\n' "$(guest_has_mount "$instance" "$HOME/.config/gh" && printf yes || printf no)"
    printf 'ssh_mount_ok=%s\n' "$(guest_has_mount "$instance" "$HOME/.ssh" && printf yes || printf no)"
    printf 'mount_policy='
    limactl shell "$instance" bash -lc "cat \"$GUEST_MOUNT_POLICY_PATH\" 2>/dev/null || true"
    printf 'codex_installed=%s\n' "$(limactl shell "$instance" command -v codex >/dev/null 2>&1 && printf yes || printf no)"
    printf 'claude_installed=%s\n' "$(limactl shell "$instance" command -v claude >/dev/null 2>&1 && printf yes || printf no)"
    printf 'opencode_installed=%s\n' "$(limactl shell "$instance" command -v opencode >/dev/null 2>&1 && printf yes || printf no)"
    printf 'gh_installed=%s\n' "$(limactl shell "$instance" command -v gh >/dev/null 2>&1 && printf yes || printf no)"
  fi
}

install_shims() {
  local target_dir="${1:-$HOME/.local/bin}"

  mkdir -p "$target_dir"
  ln -sfn "$SHIMS_DIR/codex" "$target_dir/codex"
  ln -sfn "$SHIMS_DIR/claude" "$target_dir/claude"
  ln -sfn "$SHIMS_DIR/opencode" "$target_dir/opencode"

  log "Installed shims to $target_dir"
  printf 'Add to PATH if needed: export PATH="%s:$PATH"\n' "$target_dir"
}

base_init() {
  ensure_base_instance
  log "Base VM ready: ${AGENTVM_BASE_INSTANCE:-$BASE_INSTANCE}"
}

base_apply() {
  ensure_base_instance
  log "Base manifest apply complete"
}

base_shell() {
  local base="${AGENTVM_BASE_INSTANCE:-$BASE_INSTANCE}"
  ensure_base_instance
  log "Opening shell in $base"
  lima_retry limactl shell "$base"
}

base_snapshot() {
  local base="${AGENTVM_BASE_INSTANCE:-$BASE_INSTANCE}"
  local snap="${AGENTVM_BASE_SNAPSHOT:-$BASE_SNAPSHOT}"

  ensure_base_instance
  limactl stop "$base" >/dev/null 2>&1 || true
  log "Refreshing base snapshot '$snap'"
  limactl snapshot delete "$base" "$snap" >/dev/null 2>&1 || true
  lima_retry limactl snapshot create "$base" "$snap"
}

base_reset() {
  local base="${AGENTVM_BASE_INSTANCE:-$BASE_INSTANCE}"
  local snap="${AGENTVM_BASE_SNAPSHOT:-$BASE_SNAPSHOT}"

  instance_exists "$base" || die "Base VM '$base' does not exist"
  limactl stop "$base" >/dev/null 2>&1 || true
  log "Restoring base VM from snapshot '$snap'"
  lima_retry limactl snapshot apply "$base" "$snap"
  log "Base VM reset complete"
}

main() {
  require_bin limactl
  if ! has_bin shasum && ! has_bin sha256sum; then
    die "Missing required binary: shasum or sha256sum"
  fi

  local cmd="${1:-}"
  case "$cmd" in
    claude|codex|opencode)
      shift
      run_agent "$cmd" "$@"
      ;;
    gh)
      shift
      run_gh "$@"
      ;;
    run)
      shift
      [ "${1:-}" ] || die "Usage: ${TOOL_NAME} run <claude|codex|opencode> [args...]"
      local agent="$1"
      shift
      run_agent "$agent" "$@"
      ;;
    status)
      show_status
      ;;
    list)
      show_list
      ;;
    rm)
      shift
      remove_instance "${1:-}"
      ;;
    prune)
      prune_instances
      ;;
    doctor)
      show_doctor
      ;;
    install-shims)
      shift
      install_shims "${1:-}"
      ;;
    base)
      shift
      case "${1:-}" in
        init) base_init ;;
        apply) base_apply ;;
        shell) base_shell ;;
        snapshot) base_snapshot ;;
        reset) base_reset ;;
        *) usage; exit 1 ;;
      esac
      ;;
    -h|--help|help|"")
      usage
      ;;
    *)
      usage
      die "Unknown command: $cmd"
      ;;
  esac
}

main "$@"
